

PAGINADO POR BACK

paginate: (req, res) => {
        const { page, size } = req.query;
        let pagina = parseInt(page);
        let tamano = parseInt(size);
        db.Product.findAll(
            {
                where: {
                    estado: 'A'
                },
                raw: true,
                attributes: ['title'],
                limit : tamano,
                offset : pagina * tamano
            }

        ).then(product => {
            let respuesta = {
                products: product,
                status: 200
            }
            res.status(200).json(respuesta);
        })
    },


    import React, { useState, useEffect } from "react";
import Products from "./Products";

function ContentAllProducts() {
  const [productsPage, setProductsPage] = useState([]);
  const [cantPage, setCantPage] = useState(0);
  const [pageActual, setPageActual] = useState(1);

  const handlePageNext = () => {
    if (pageActual < cantPage) {
      setPageActual(pageActual + 1);
    }
  };

  const handlePageLast = () => {
    setPageActual(cantPage);
  };

  const handlePagePrevious = () => {
    if (pageActual > 1) {
      setPageActual(pageActual - 1);
    }
  };

  const handlePageFirst = () => {
      setPageActual(1);
  };

  useEffect(() => {
    fetch("/api/products/all/")
      .then((respuesta) => {
        return respuesta.json();
      })
      .then((data) => {
        setCantPage(Math.ceil(data.products.length / 4));
      })
      .catch((error) => console.log(error));
  }, []);

  useEffect(() => {
    fetch(`/api/products/page?page=${pageActual - 1}&size=4`)
      .then((respuesta) => {
        return respuesta.json();
      })
      .then((data) => {
        setProductsPage(data.products);
      })
      .catch((error) => console.log(error));
  }, [pageActual]);

  return (
    <React.Fragment>
      {/*<!-- Categories in DB -->*/}
      <div className="col-lg-12 mb-4">
        <div className="card shadow mb-4">
          <div className="card-header py-3">
            <h6 className="m-0 font-weight-bold text-gray-800">
              TODOS LOS PRODUCTOS
            </h6>
          </div>
          <div className="card-body">
            <div className="row">
              {productsPage.map((product, index) => {
                return <Products title={product.title} key={index} />;
              })}
            </div>
            <div className="col-12">
              <button
                className="btn btn-success mr-1"
                onClick={handlePageFirst}
              >
                {"|<"}
              </button>
              <button
                className="btn btn-primary mr-3"
                onClick={handlePagePrevious}
              >
                {"<"}
              </button>
              <span>
                {pageActual} / {cantPage}
              </span>
              <button className="btn btn-primary ml-3" onClick={handlePageNext}>
                {">"}
              </button>
              <button className="btn btn-success ml-1" onClick={handlePageLast}>
                {">|"}
              </button>
            </div>
          </div>
        </div>
      </div>
    </React.Fragment>
  );
}

export default ContentAllProducts;


DATA TABLE PARA REACT ES UNA LIBRERIA 

import React, { useState, useEffect } from "react";
import DataTable from 'react-data-table-component'

const columnas = [
    {
        name: 'ID',
        selector: 'id',
        sortable: true,
        grow: 0
    },
    {
        name: 'TITULO',
        selector: 'title',
        sortable: true,
        grow: 4
    },
    {
        name: 'PRECIO',
        selector: 'price',
        sortable: true,
        right: true
    },
    {
        name: 'DESC',
        selector: 'discount',
        sortable: true,
        center: true,
        grow: 0
    },
    {
        name: 'CATEGORIA',
        selector: 'category',
        sortable: true,
        grow: 1
    },
    {
        name: 'SUBCATEGORIA',
        selector: 'subcategory',
        sortable: true,
        grow: 1
    }
];

const paginacionOpciones = {
    rowsPerPageText: 'Filas por Página',
    rangeSeparatorText: 'de',
    selectAllRowsItem: true,
    selectAllRowsItemText: 'Todos'
}

function ContentDataTableProducts () {
    const [tablaProducts, setTablaProducts] = useState([]);
    useEffect(() => {
        fetch("/api/products/datatable")
          .then((respuesta) => {
            return respuesta.json();
          })
          .then((data) => {
            setTablaProducts(data.products);
          })
          .catch((error) => console.log(error));
    },[])

    return (
        <div className="content-wrapper">
            <div className="row ml-1 mr-1 mt-4">
                <div className="col-lg-12 mb-4">						
                    <div className="card shadow mb-4">
                        <div className="card-header py-3 bg-warning">
                            <h6 className="m-0 font-weight-bold text-gray-800">TODOS LOS PRODUCTOS</h6>
                        </div>
                        <div className="card-body table-responsive">
                            <DataTable 
                                columns={columnas}
                                data={tablaProducts}
                                title="Listado general de productos"
                                pagination
                                paginationComponentOptions={paginacionOpciones}
                                fixedHeader
                                fixedHeaderScrollHeight="300px"
                            />
                        </div>
                    </div>
                </div>
            </div>
        </div>
    )
}

export default ContentDataTableProducts


// Comprobar que no exista el usuario por su email

        db.Users.findOne(
            {
                where: {
                    email: req.body.email
                }
            }
        )
        .then(user => {
            let userInDB = JSON.parse(JSON.stringify(user));

            if(userInDB) {

                    if(req.file) {
                        if(req.file.filename) {
                            if(req.file.filename != 'user_default.png') {
                                fs.unlinkSync(path.join(__dirname, '../../public/img/users/'+req.file.filename))
                            }
                        }
                    }

                return res.render('users/register', {
                    categories,
                    subCategories,
                    afip,
                    zoneDatabase,
                    nombrePagina: 'Registro',
                    errors: {
                        email: {
                            msg: '(*) Este email ya está registrado'
                        }
                    },
                    oldData: req.body
                });
            }

            db.Users.create(
                {
                    fullName: req.body.fullName,
                    dni_cuit: parseInt(req.body.dni_cuit),
                    phone: parseInt(req.body.phone),
                    email: req.body.email,
                    invoice_type_id: parseInt(req.body.invoice_type_id),
                    street: req.body.street,
                    number: parseInt(req.body.number),
                    floor: req.body.floor,
                    flat: req.body.flat,
                    zip: parseInt(req.body.zip),
                    city: req.body.city,
                    state_id: parseInt(req.body.state),
                    password: bcryptjs.hashSync(req.body.password, 10),
                    avatar: req.file ? req.file.filename : 'user_default.png',
                    roll_user_id: 2,
                    reference: req.body.reference
                }
            )
            .then(()=> {
                return res.redirect('/users/login')})            
            .catch(error => res.send(error))
        })



body('password')
		.notEmpty().withMessage('(*) Tienes que escribir una contraseña').bail()
    .isLength({ min: 8}).withMessage('(*) Debe contener un mínimo de 8 carateres')
    .custom((value, { req }) => {
      
      const regex = new RegExp(/^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)(?=.*[@$!%*?&])[A-Za-z\d@$!%*?&]{8,}$/);
      if (!regex.test(value) ) {
        throw new Error('(*) La contraseña debe tener al menos, una letra mayúscula, una minúscula, un número y un carácter especial');
      }
      console.log(regex.test(value));
      return true;
    }),

API PARA PRODUCTOS
all: (req, res) => {
        let products = db.Product.findAll({where: {estado: 'A'}});
        let categories = db.Category.findAll({where: {estado : 'A'}});
        Promise.all([products, categories]). then(([products, categories]) => {
            let productsToSend = products.map((product) => product.dataValues);
            let categoriesToSend = categories.map((category) => category.dataValues);

            let namesCategories = [];
            let countCategories = [];
            let idCategories = [];

            categoriesToSend.forEach((category) => {
                idCategories.push(category.id);
                namesCategories.push(category.name);
                countCategories.push(0);
            })

            let conatdor = 0;

            idCategories.forEach((categoryId) => {
                conatdor = 0;
                productsToSend.forEach((product) => {
                    if(product.category_id == categoryId) {
                        conatdor = conatdor + 1;
                        countCategories[categoryId - 1] = conatdor;
                    }
                })
            })
            
            idCategories.shift();
            namesCategories.shift();
            countCategories.shift();

            let countCategoryToSend = [];
            for (let i = 0; i < namesCategories.length; i++) {
                countCategoryToSend.push(namesCategories[i] + ':  ' + countCategories[i]);
            }

            productsToSend.forEach((product) => {
                delete product.discount;
                delete product.promotion;
                delete product.img;
                delete product.estado;
                delete product.category_id;
                delete product.subcategory_id;
                product.dbaseRelations = "category_id";
                product.detailUrl = `http://localhost:4000/api/product/${product.id}`
            })

            let dataToSend = { countProducts: products.length,
                categoriesCount: countCategories.length,
                countByCategory: countCategoryToSend,
                products: productsToSend,
                status: 200
            }

            return res.status(200).json(dataToSend);

        })
    },

    ROYAAL 
    let products = db.Product.findAll();
    let brands = db.Brand.findAll();
    Promise.all([products, brands]). then(([products, brands]) => {
        let processedProducts = products.map((product) => product.dataValues);
        let processedBrands = brands.map((brand) => brand.dataValues);
   
         let namesBrands = [];
            let countBrands = [];
            let idBrands = [];

            processedBrands.forEach((brand) => {
                idBrands.push(brand.id);
                namesBrands.push(brand.name);
                countBrands.push(0);
            })
            let counter = 0;

            idBrands.forEach((brandId) => {
                counter = 0;
                processedProducts.forEach((product) => {
                    if(product.products_brands_id == brandId) {
                        counter = counter + 1;
                        countBrands[brandId - 1] = counter;
                    }
                })
            }) 
            let countBrandsProcessed = [];
            for (let i = 0; i <  namesBrands.length; i++) {
                countBrandsProcessed.push(namesBrands[i] + ':  ' + countBrands[i]);
            }
            processedProducts.forEach((product) => {
                delete product.year;
                delete product.price;
                delete product.image;
                delete product.products_brands_id;
                product.detailUrl = `http://localhost:3000/api/products/${product.id}`
            })
            let dataToSend = { countProducts: products.length,
                countByBrand: countBrandsProcessed,
                brandsCount: countBrands.length,
                products: processedProducts,
                status: 200
            }

            return res.status(200).json(dataToSend);

        })

